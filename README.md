# 📚 Онлайн-Библиотека

Добро пожаловать в **Online Library** — 📖 современный и масштабируемый API-сервис для работы с онлайн-библиотекой. 
Проект построен на **FastAPI** и разделён на модули с чистой архитектурой, включает фоновую обработку задач через **Celery** и хранение данных в **PostgreSQL** и **Redis**.

Проект 🧠 **Online Library API** — это веб-приложение для управления электронной библиотекой с функционалом пользователей, книг, отзывов, избранного, статистики, загрузки файлов и фоновыми задачами.
---

## 📂 Структура проекта
```
/online-library
│── src/                   # Основная директория с исходным кодом
│   │── api/               # Маршруты FastAPI (эндпоинты)
│   │   ├── v1/            # Версионирование API
│   │   │   ├── auth.py            # Аутентификация и авторизация
│   │   │   ├── users.py           # Роуты для пользователей
│   │   │   ├── books.py           # Роуты для книг
│   │   │   ├── reviews.py         # Роуты для отзывов
│   │   │   ├── favorites.py       # Роуты для избранного
│   │   │   ├── images.py          # Роуты для работы с файлами (загрузка обложек, книг)
│   │   │   ├── statistics.py      # Роуты для статистики
│   │── core/              # Основные настройки
│   │   ├── config.py              # Конфигурация проекта
│   │   ├── celery.py              # Настройки Celery
│   │   ├── redis.py               # Управление соединением и работой с Redis
│   │── db/                # Работа с БД
│   │   ├── session.py             # Настройки подключения к БД 
│   │   ├── base.py                # Базовая модель для всех ORM-классов
│   │   ├── manager.py             # Менеджер работы с базой данных
│   │── dependencies/      # Зависимости
│   │   ├── database.py            # Зависимость для работы с базой данных
│   │   ├── user.py                # Авторизационные зависимости
│   │   ├── pagination.py          # Зависимость для пагинации
│   │── models/            # SQLAlchemy-модели
│   │   ├── book.py                # Модель Book
│   │   ├── user.py                # Модель User
│   │   ├── review.py              # Модель Review
│   │   ├── favorite.py            # Модель Favorite
│   │   ├── role.py                # Модель UserRole
│   │   ├── image.py               # Модель Image
│   │   ├── stat_views.py          # Модели статистики
│   │── schemas/           # Pydantic-схемы
│   │   ├── book.py                # Схемы для книг
│   │   ├── user.py                # Схемы для пользователей
│   │   ├── review.py              # Схемы для отзывов
│   │   ├── favorite.py            # Схемы для избранного
│   │   ├── image.py               # Схемы для изображений
│   │   ├── statistics.py          # Схемы для статистики
│   │── repositories/      # Репозитории (работа с БД)
│   │   ├── base.py                # Базовый репозиторий
│   │   ├── user.py                # Репозиторий для работы с пользователями
│   │   ├── ubook.py               # Репозиторий для работы с книгами
│   │   ├── review.py              # Репозиторий для отзывов
│   │   ├── favorite.py            # Репозиторий для избранного
│   │   ├── image.py               # Репозиторий для изображений
│   │   ├── statistics.py          # Репозиторий для статистики
│   │── services/          # Сервисный слой
│   │   ├── base.py                # Базовый сервис
│   │   ├── auth.py                # Сервис для работы с авторизацией
│   │   ├── user.py                # Сервис для работы с пользователями
│   │   ├── book.py                # Сервис для работы с книгами  
│   │   ├── review.py              # Сервис для работы с отзывами
│   │   ├── favorite.py            # Сервис для работы с избранным
│   │   ├── image.py               # Сервис для работы с изображениями
│   │   ├── statistics.py          # Сервис для работы со статистикой
│   │── mappers/          # Дата маппер
│   │   ├── base.py                # Базовый маппер
│   │   ├── mappers.py             # Набор мапперов по сущностям
│   │── exceptions/       # Исключения
│   │   ├── base.py                # Базовый класс исключений
│   │   ├── auth.py                # Исключения для авторизации
│   │   ├── user.p                 # Исключения для пользователей
│   │   ├── ybook.py               # Исключения для книг
│   │   ├── review.py              # Исключения для отзывов
│   │   ├── favorite.py            # Исключения для избранного
│   │   ├── image.py               # Исключения для изображений
│   │── tasks/             # Фоновые задачи Celery
│   │   ├── celery_tasks.py        # Уведомления
│   │   ├── email_sender.py        # Генерация отчетов
│   │   ├── utils.py               # Вспомогательные функции для фоновых задач
│   │── static/            # Директория для статических файлов
│   │── main.py            # Точка входа в приложение
```
---
## 🧩 Структура базы данных
![er_diagram_from_models](https://github.com/user-attachments/assets/ae1ce453-13eb-4aac-9b28-63ab679f5a28)

---

## 🧾 Общее описание проекта

- Регистрация и авторизация пользователей
- Управление книгами, избранным и отзывами
- Загрузка обложек и файлов книг
- Получение аналитической статистики
- Фоновые задачи и отправка email-отчетов
---

## 💡 Возможности проекта

### 👤 Пользователи

#### 🔐 Регистрация, активация, аутентификация и авторизация

* Регистрация по имени пользователя, email и паролю.
* После регистрации:

  * Пользователю автоматически назначается роль `user`.
  * Аккаунт считается **неактивным** до активации.
* Активация по коду, отправленному на email.
* Срок активации — **72 часа**, после чего неактивный пользователь **удаляется**.
* Возможность прямой регистрации администратора (роль `admin`) по данным из `.env`:
  `ADMIN_EMAIL`, `ADMIN_NAME`, `ADMIN_PASSWORD`.
* Получение информации о текущем пользователе.
* Выход из системы.
* Запрос на повышение роли до `author` — отправляется уведомление администратору по email.

#### ⚙️ Управление пользователями (доступно **только** администратору)

* Получение списка всех зарегистрированных пользователей.
* Изменение роли пользователя (при переходе на роль `author` отправляется email-уведомление).
* Удаление пользователей.

### 📚 Книги

* Получение списка всех книг (с пагинацией):
  фильтрация по:

  * среднему рейтингу
  * количеству отзывов
  * подстроке в заголовке
  * подстроке в описании
* Добавление новой книги (**только для авторов и админов**) — необходимо загрузить PDF-файл.
* Получение данных конкретной книги.
* Полное/частичное редактирование книги — **только автор книги или админ**.
* Удаление книги — **только автор книги или админ**.

### 📝 Отзывы на книги

* Получение всех отзывов на все книги (**только для админа**, с пагинацией).
* Получение конкретного отзыва.
* Получение всех отзывов на конкретную книгу.
* Добавление отзыва к книге:

  * Один пользователь может оставить **только один отзыв** на одну книгу.
  * Автор книги получает уведомление на email о добавлении отзыва.
* Редактирование/удаление отзыва — доступно автору отзыва или админу.

### ⭐ Избранное

* Получение списка избранных книг текущего пользователя (с пагинацией).
* Добавление книги в избранное текущего пользователя.
* Удаление книги из избранного текущего пользователя.

### 🖼️ Изображения

* Загрузка обложки книги (**только для автора книги или админа**).
* Получение списка изображений книги.
* Получение конкретного изображения.

### 📊 Статистика (только для **администратора**)

* **Популярные книги** — с отзывами и хотя бы одним добавлением в избранное.
  ⚠️ При запросе обновляется *материализованное представление*.

* **Топ-авторы** — книги с отзывами.
  ⚠️ При запросе обновляется *материализованное представление*.

* **Отзывы и рейтинг**:

  * общее количество отзывов
  * минимальный, максимальный и средний рейтинг
    ⚠️ При запросе обновляется *материализованное представление*.

* 📧 **Ежедневная рассылка** администратору со статистикой — во вложении XLSX-файл.
---

## 🛠️ Стек технологий

- 🐍 Python 3.12+
- ⚡ FastAPI
- 🐘 PostgreSQL
- 🧵 SQLAlchemy
- 🧰 Alembic
- 🐇 Celery + Redis
- 📬 SMTP (email-уведомления)
- 🐳 Docker, docker-compose
---

## 📥 Скачивание проекта

### Клонирование репозитория

```bash
  git clone https://github.com/afonick/online-library.git
```

## 🚀 Варианты запуска

### 🐍 Локальный запуск

Запуск напрямую в вашей системе, используя установленный Python

#### 1. Установка необходимых инструментов

Убедитесь, что у вас установлены 
* **Python 3.12**
* **virtualenv**
* **PostgreSQL** (для локальной БД)
* **Redis** (для фоновых задач и кеширования)

#### 2. Создание и активация виртуального окружения

#### 3. Установка зависимостей

```bash
  pip install -r requirements.txt
```

#### 4. Настройка переменных окружения

Переименуйте файл `.env.example` в `.env` и укажите необходимые значения для переменных окружения

#### 5. Применение миграций

```bash
  alembic upgrade head
```

#### 6. Запуск приложения

```bash
  python src/main.py
```

#### 7. Запуск Celery

```bash
  celery -A src.core.celery worker -l INFO
```

#### 8. Запуск планировщика задач

```bash
  celery -A src.core.celery beat -l INFO
```

#### 9. Доступ к приложению

* URL: [http://localhost:8000](http://localhost:8000)
---

### 🐳 Контейнерный запуск (через Docker)

Изолированный запуск всех компонентов с помощью Docker Compose.

#### 1. Установка Docker и Docker Compose

#### 2. Настройка переменных окружения

Переименуйте файл `.env.docker.example` в `.env.docker` и укажите необходимые значения для переменных окружения

#### 3. Создание docker-образа приложения

```bash
  docker build -t library .
```

#### 4. Запуск проекта

```bash
  docker-compose up -d
```

> При этом автоматически поднимутся:
>
> * FastAPI-приложение
> * PostgreSQL
> * Redis
> * Celery Worker
> * Celery Beat
> * Nginx

#### 5. Доступ к приложению

* URL: [http://localhost](http://localhost)
---

## 🏁 Деплой

Проект развернут на удалённом сервере и доступен в сети интернет по адресу:

🔗 [https://afonick-library.ru](https://afonick-library.ru)

✅ Сервер работает 24/7  
🔒 HTTPS включён
---

